<!-- 0. Base & Responsive Styles -->
<style>
  body {
    font-family: Inter, -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
    background: #fff;
    margin: 0;
    padding: 0;
  }
  #onboarding-outer {
    max-width: 800px;
    margin: 0 auto;
    padding: 2rem 1rem 3rem 1rem;
  }
  #onboarding-checklist h2 {
    font-size: 1.65rem;
    font-weight: 700;
    margin: 1.8rem 0 1.1rem 0;
    letter-spacing: -0.01em;
    color: #19213a;
  }
  #onboarding-checklist h3 {
    font-size: 1.15rem;
    font-weight: 600;
    margin: 1.2rem 0 0.7rem 0;
    color: #32406e;
    letter-spacing: 0.01em;
  }
  #onboarding-checklist .details-table {
    max-width: 640px;
    margin: 0 auto 2rem auto;
    padding: 1.25rem 1.5rem 1.25rem 1.5rem;
    border: 1px solid #dee4ec;
    border-radius: 12px;
    background: #f8fafc;
    box-sizing: border-box;
    font-size: 1.09rem;
    box-shadow: 0 2px 8px 0 #1a21351a;
  }
  #onboarding-checklist .details-header {
    font-size: 1.14rem;
    font-weight: 600;
    margin-bottom: 0.8em;
    color: #32406e;
    letter-spacing: 0.01em;
  }
  #onboarding-checklist .details-label {
    min-width: 105px;
    display: inline-block;
    font-weight: 500;
    padding-right: 1em;
    vertical-align: top;
    color: #2e3d5d;
  }
  #onboarding-checklist .details-ok {
    color: #243153;
    word-break: break-word;
    max-width: 240px;
  }
  #onboarding-checklist .details-missing {
    color: #c62828;
    font-weight: 600;
    word-break: break-word;
    max-width: 240px;
  }
  #onboarding-checklist .details-missing span[title] {
    margin-left: .2em;
    font-size: 1em;
    vertical-align: middle;
  }
  #onboarding-checklist .details-table td {
    padding-bottom: 0.3em;
  }
  #onboarding-checklist .details-table th {
    text-align: left;
    font-weight: 500;
    padding-bottom: 0.3em;
  }
  #onboarding-checklist ul {
    list-style: none;
    padding: 0;
    margin: 0;
  }
  #onboarding-checklist li {
    margin: 1rem 0;
    font-size: 1.09rem;
  }
  #onboarding-checklist .btn {
    display: inline-block;
    padding: 0.5em 1.2em;
    margin-left: 0.5em;
    background: #2154fc;
    color: #fff;
    font-size: 0.93rem;
    font-weight: 500;
    border: none;
    border-radius: 8px;
    text-decoration: none;
    cursor: pointer;
    transition: transform .1s, box-shadow .1s, background .2s;
    box-shadow: 0 2px 4px rgba(0,0,0,0.08);
  }
  #onboarding-checklist .btn:hover {
    background: #173aa7;
    transform: translateY(-1px);
    box-shadow: 0 4px 10px rgba(33,84,252,0.13);
  }
  /* Checklist box styling */
  #onboarding-checklist .checklist-block {
    max-width: 640px;
    margin: 0 auto 2.2rem auto;
    padding: 1.5rem 1.2rem 1.2rem 1.2rem;
    border: 1.2px solid #dee4ec;
    border-radius: 13px;
    background: #f7faff;
    box-shadow: 0 2px 8px #32406e10;
  }
  #onboarding-checklist .checklist-block li {
    margin: 1.1rem 0;
    font-size: 1.09rem;
  }
  /* Responsive tweaks */
  @media (max-width: 600px) {
    #onboarding-outer {
      padding: 0.5rem 0.2rem 2rem 0.2rem;
    }
    #onboarding-checklist h2 {
      font-size: 1.19rem;
      margin-bottom: 1.25rem;
    }
    #onboarding-checklist .details-table {
      padding: 0.8rem 0.5rem;
      font-size: 1rem;
    }
    #onboarding-checklist .details-label {
      min-width: 92px;
      padding-right: 0.6em;
      font-size: 1rem;
    }
    #onboarding-checklist .details-ok,
    #onboarding-checklist .details-missing {
      max-width: 99vw;
      display: block;
      overflow-wrap: break-word;
      word-break: break-word;
    }
    #onboarding-checklist table {
      width: 100%;
      table-layout: fixed;
    }
    #onboarding-checklist td, #onboarding-checklist th {
      font-size: 1rem;
      vertical-align: top;
      word-break: break-word;
      overflow-wrap: break-word;
    }
    #onboarding-checklist .btn {
      width: 100%;
      margin: 0.5em 0 0 0;
      font-size: 1rem;
    }
  }
  /* Spinner */
  #onboarding-spinner {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 180px;
    font-size: 1.15rem;
    color: #222;
  }
  .spinner {
    border: 4px solid #eee;
    border-top: 4px solid #2154fc;
    border-radius: 50%;
    width: 38px;
    height: 38px;
    animation: spin 1s linear infinite;
    margin-bottom: 1.15em;
  }
  /* Bombers app download row */
  #app-download-row {
    max-width: 640px;
    margin: 2.5rem auto 1.5rem auto;
    padding: 1.2rem 1.2rem 1.2rem 1.2rem;
    border: 1.2px solid #dee4ec;
    border-radius: 13px;
    background: #f7faff;
    box-shadow: 0 2px 8px #32406e10;
    text-align: center;
  }
  #app-download-row .btn {
    margin: 0.2em 0.5em 0.2em 0.5em;
    font-size: 1.07rem;
  }
</style>

<div id="onboarding-outer">
  <div id="onboarding-checklist">
    <div id="onboarding-spinner">
      <div class="spinner"></div>
      <div>Fetching your details…</div>
    </div>
  </div>
  <!-- Bombers App Download Row -->
  <div id="app-download-row" style="display:none">
    <div style="font-weight:600;margin-bottom:0.6em;">Download the Bombers App</div>
    <a class="btn" href="https://apps.apple.com/gb/app/bombers-physical-training/id1589832573" target="_blank">iOS</a>
    <a class="btn" href="https://play.google.com/store/apps/details?id=com.pushpress.bombersphysicaltraining&gl=GB" target="_blank">Android</a>
  </div>
</div>

<!-- Confetti for ticks -->
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<script>
(function(){
  let contactId = new URLSearchParams(window.location.search).get("contactId");
  if (!contactId) {
    const m = window.location.pathname.match(/-contactId=([^\/]+)/);
    contactId = m ? m[1] : null;
  }
  const container = document.getElementById("onboarding-checklist");
  const appDownloadRow = document.getElementById("app-download-row");
  if (!container) return;

  let loading = false;
  let loadedOnce = false;
  let bpEditMode = false;

  const FIELDS = {
    APPT_DATE:   "BP5YJXFaKjFrmz0N53J4",
    APPT_TIME:   "QL8Rg5ozgb1pPHKfdoGs",
    APPT_COACH:  "Iczk4Pcm4XecHzZZj31E",
    BP_RESULT:   "Cvzpen1uIP6CNffM6BwN",
    TRIAL_START: "kqpNMwQER3ljj3r6mZxi",
    PIN:         "rkCkFkCpBjfPQk8YvHG4",
    PHONE:       "npNqCUwvXd09eIV882kT"
  };
  const TAGS = {
    CONSULT_DONE:   "consultation form submitted",
    PARQ_SUBMITTED: "par-q submitted",
    NSI_BOOKED:     "nsi booked",
    DC_BOOKED:      "discovery call booked",
    INTRO_ATTENDED: "attended intro",
    INTRO_NOSHOW:   "intro no show",
    INDUCTION_DONE: "online induction completed",
    PURCHASED_1TO1: "initial 1-1 purchased",
    BOOKED_1TO1:    "on-boarding 1-1 booked",
    DEBRIEF_DONE:   "initial 1-1 debrief completed",
    MEMBERSHIP_DONE:"membership form submitted"
  };

  function burst(){
    const dur=2000,end=Date.now()+dur,defs={startVelocity:30,spread:360,ticks:60,zIndex:9999};
    const iv = setInterval(()=>{
      if(Date.now()>end) return clearInterval(iv);
      confetti(Object.assign({},defs,{particleCount:40,origin:{x:Math.random(),y:Math.random()-0.2}}));
    },250);
  }

  function isManual(k){ return localStorage.getItem("chk_"+k)==="1"; }
  function setManual(k){ localStorage.setItem("chk_"+k,"1"); }

  async function saveBP(v){
    const res = await fetch(`https://ghl-proxy.fly.dev/contact/${contactId}`, {
      method:"PATCH",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ customFields:[{id:FIELDS.BP_RESULT,value:v}] })
    });
    if(!res.ok) throw new Error(res.statusText);
  }

  function getPINStatus(pin, startTimeStr) {
    if (!pin || !startTimeStr) return "PIN will be available closer to your session time.";
    const now = new Date();
    const start = new Date(startTimeStr);
    const unlockTime = new Date(start.getTime() - 15 * 60000);
    if (now < unlockTime) return "PIN will be available closer to your session time.";
    return `Your PIN is ${pin}`;
  }

  // ==== RENDER YOUR DETAILS SECTION ====
  function renderYourDetailsSection(contact, customFields) {
    contact = contact || {};
    customFields = Array.isArray(customFields) ? customFields : [];
    const getF = id => {
      const f = customFields.find(f => f.id === id);
      return f ? f.value : "";
    };
    const firstName = contact.firstName || "";
    const lastName = contact.lastName || "";
    const email = contact.email || "";
    const phone = getF(FIELDS.PHONE) || "";
    const dob = contact.dateOfBirth || "";

    function isNameValid(n) { return n && n.length > 1; }
    function isEmailValid(e) { return !!e && /\S+@\S+\.\S+/.test(e); }
    function isPhoneValid(p) { return !!p && /^\+?\d{10,}$/.test((p+"").replace(/\s/g,"")); }
    function isDOBValid(d) { return !!d && /^\d{4}-\d{2}-\d{2}$/.test(d); }

    function row(label, value, valid) {
      let valHTML = value ? value : "<span>Missing</span>";
      if (!valid)
        valHTML += ' <span title="Missing or invalid">&#9888;</span>';
      return `<tr>
        <th class="details-label">${label}:</th>
        <td class="${valid ? 'details-ok' : 'details-missing'}">${valHTML}</td>
      </tr>`;
    }

    let html = `<div class="details-table">
      <div class="details-header">Your Details</div>
      <table style="border-collapse:collapse;width:100%;background:none;">
        ${row("Name", (firstName + (lastName ? " " + lastName : "")), isNameValid(firstName) && isNameValid(lastName))}
        ${row("Phone", phone, isPhoneValid(phone))}
        ${row("Email", email, isEmailValid(email))}
        ${row("Date of Birth", dob, isDOBValid(dob))}
      </table>
    </div>`;
    return html;
  }
  // ==== END RENDER YOUR DETAILS SECTION ====

  // === RENDER BLOOD PRESSURE SUBITEM ===
  function renderBPItem(bp, editing) {
    if (bp) {
      return `✅ Blood Pressure Check<div style='margin-left:1.5em;color:#555'>Results: ${bp}</div>`;
    }
    if (editing) {
      return `
        ⬜ Blood Pressure Check
        <div style='margin-left:1.5em;'>
          <input id="bp-input" type="text" style="padding:0.2em 0.6em;font-size:1rem;width:110px;" placeholder="e.g. 120/80">
          <button class="btn" style="margin-left:0.5em;" onclick="window.saveBPResult()">Save</button>
          <button class="btn" style="background:#ddd;color:#222;margin-left:0.5em;" onclick="window.cancelBPEntry()">Cancel</button>
        </div>
      `;
    }
    return `⬜ Blood Pressure Check <button class="btn" style="margin-left:1em;" onclick="window.startBPEntry()">Enter Results</button>`;
  }

  // === MAKE BP ENTRY EDITABLE ===
  window.startBPEntry = function() {
    bpEditMode = true;
    renderChecklist();
  };
  window.cancelBPEntry = function() {
    bpEditMode = false;
    renderChecklist();
  };
  window.saveBPResult = async function() {
    const input = document.getElementById('bp-input');
    if (!input || !input.value) {
      alert("Please enter a value.");
      return;
    }
    try {
      await saveBP(input.value);
      bpEditMode = false;
      renderChecklist();
    } catch (e) {
      alert("Failed to save blood pressure.");
    }
  };

  async function renderChecklist(){
    if (loading) return;
    if(!contactId){
      container.innerHTML = "<p style='color:red;'>No contactId in URL.</p>";
      return;
    }
    if (!loadedOnce) {
      container.innerHTML = `
        <div id="onboarding-spinner">
          <div class="spinner"></div>
          <div>Fetching your details…</div>
        </div>
      `;
    }
    loading = true;
    let data;
    try{
      const r = await fetch(`https://ghl-proxy.fly.dev/contact/${contactId}`);
      data = await r.json();
      loadedOnce = true;
    }catch(e){
      container.innerHTML = "<p style='color:red;'>Error loading data from server.<br>"+(e.message||e)+"</p>";
      loading = false;
      return;
    }
    loading = false;

    const contact = (data && data.contact) ? data.contact : {};
    const tags = contact.tags || [];
    const fieldsArr = Array.isArray(contact.customField) ? contact.customField : [];
    const fields = Object.fromEntries(fieldsArr.map(f=>[f.id,f.value||""]));
    const hasTag = t=>tags.includes(t), getF=id=>fields[id]||"";

    // Show Bombers App links always
    if (appDownloadRow) appDownloadRow.style.display = 'block';

    // Headings: details, enquiry, trial
    let html = "";
    try {
      html += renderYourDetailsSection(contact, fieldsArr);
    } catch (e) {
      html += `<div style="max-width:640px;margin:1em auto 2em;font-family:Inter,sans-serif;padding:1em 1.5em;background:#ffeaea;border:1px solid #c62828;color:#b71c1c;border-radius:7px">
        <b>Error rendering your details</b><br>
        ${e.message||e}
      </div>`;
    }

    const consultationDone = hasTag(TAGS.CONSULT_DONE);

    const enquiry = [
      { label:"Consultation Questionnaire", done:hasTag(TAGS.CONSULT_DONE),
        button:!hasTag(TAGS.CONSULT_DONE)?{text:"Complete Now",href:`https://start.bomberspt.co.uk/about-you?contactId=${contactId}`} :null },
      { label:"Health Questionnaire", done:hasTag(TAGS.PARQ_SUBMITTED),
        button:!hasTag(TAGS.PARQ_SUBMITTED)?{text:"Complete Now",href:`https://start.bomberspt.co.uk/health-questionnaire?contactId=${contactId}`} :null },
      { label:"Intro Meeting",
        done:hasTag(TAGS.NSI_BOOKED)||hasTag(TAGS.DC_BOOKED),
        status: hasTag(TAGS.INTRO_ATTENDED)?"Attended" : hasTag(TAGS.INTRO_NOSHOW)?"No show" : (hasTag(TAGS.NSI_BOOKED)||hasTag(TAGS.DC_BOOKED))?"Scheduled":null,
        details:(hasTag(TAGS.NSI_BOOKED)||hasTag(TAGS.DC_BOOKED))?`${getF(FIELDS.APPT_TIME)} on ${getF(FIELDS.APPT_DATE)} with ${getF(FIELDS.APPT_COACH)}`:"",
        button:!hasTag(TAGS.NSI_BOOKED)&&!hasTag(TAGS.DC_BOOKED)?{text:"Book Now",href:`https://start.bomberspt.co.uk/no-sweat-intro?contactId=${contactId}`} :{text:"View Details",href:`https://start.bomberspt.co.uk/your-intro?contactId=${contactId}`},
        sub:[
          {
            label: "Blood Pressure Check",
            done: !!getF(FIELDS.BP_RESULT),
            render: () => renderBPItem(getF(FIELDS.BP_RESULT), bpEditMode)
          }
        ]
      },
      { label:"Online Induction", done:hasTag(TAGS.INDUCTION_DONE),
        button:!hasTag(TAGS.INDUCTION_DONE)?{text:"Complete Now",href:"https://docs.google.com/forms/d/e/1FAIpQLSezbaFv0m6VnAydhbVc1_KRWpslYeFZa05OrYIxdfJHSeU32A/viewform"}:null }
    ];

    const trial = [
      { label:"Initial 1-1", done:hasTag(TAGS.DEBRIEF_DONE),
        status: hasTag(TAGS.DEBRIEF_DONE)?null : hasTag(TAGS.BOOKED_1TO1)?"Booked" : hasTag(TAGS.PURCHASED_1TO1)?"Purchased":null,
        button: hasTag(TAGS.DEBRIEF_DONE)?null : hasTag(TAGS.BOOKED_1TO1)?{text:"View Details",href:`https://start.bomberspt.co.uk/your-initial-1-1?contactId=${contactId}`} : hasTag(TAGS.PURCHASED_1TO1)?{text:"Book Now",href:`https://start.bomberspt.co.uk/book-initial-1-1?contactId=${contactId}`} : {text:"Purchase Now",href:`https://start.bomberspt.co.uk/purchase-initial-1-1?contactId=${contactId}`},
        sub:[
          { label:"PIN", done:!!getF(FIELDS.PIN),
            details:getPINStatus(getF(FIELDS.PIN), `${getF(FIELDS.APPT_DATE)} ${getF(FIELDS.APPT_TIME)}`) },
          { label:"1-1 Debrief", done:hasTag(TAGS.DEBRIEF_DONE),
            button:(!hasTag(TAGS.DEBRIEF_DONE)&&new Date()>=new Date(`${getF(FIELDS.APPT_DATE)}T${getF(FIELDS.APPT_TIME)}`))?{text:"Complete Debrief",href:`https://start.bomberspt.co.uk/onboarding-session-debrief?contactId=${contactId}`} : null }
        ] },
      { label:"Membership Setup", done:hasTag(TAGS.MEMBERSHIP_DONE),
        button: hasTag(TAGS.MEMBERSHIP_DONE)?{text:"Update Plan",href:`https://start.bomberspt.co.uk/membership-setup?contactId=${contactId}&editPlan=true`} : consultationDone?{text:"Choose Plan",href:`https://start.bomberspt.co.uk/membership-setup?contactId=${contactId}`} : null },
      { label:"Trial Period", done: hasTag(TAGS.DEBRIEF_DONE) && !!getF(FIELDS.TRIAL_START), details: getF(FIELDS.TRIAL_START)?`Started on ${getF(FIELDS.TRIAL_START)}`:"", button: hasTag(TAGS.DEBRIEF_DONE)?{text:"View Trial Info",href:`https://start.bomberspt.co.uk/trial-info?contactId=${contactId}`} : null }
    ];

    // Animation logic for ticks
    const all = [...enquiry, ...enquiry.flatMap(i=>(i.sub||[]).map(s=>(s.render ? {label:s.label, done:s.done, custom:true} : s))), ...(hasTag(TAGS.NSI_BOOKED)||hasTag(TAGS.DC_BOOKED)?trial:[])];
    if (window._prev){ all.forEach(item=>{ const prev = window._prev.find(p=>p.label===item.label); if (!prev || prev.done!==item.done || prev.status!==(item.status||"") || prev.details!==(item.details||"")) burst(); }); }
    window._prev = all.map(i=>({ label:i.label, done:i.done, status:i.status||"", details:i.details||"" }));
    const json = JSON.stringify(window._prev); if (json === window._last) return; window._last = json;

    // === MAIN CHECKLIST HTML START ===
    html += `<h2>Your enquiry</h2>
    <div class="checklist-block"><ul>`;
    enquiry.forEach(i=>{
      html += `<li style="display:flex;justify-content:space-between;align-items:center;margin:1rem 0"><div>${i.done?"✅":"⬜"} <strong>${i.label}</strong>${i.status?` — <em>${i.status}</em>`:""}</div><div>${
        i.button ? `<a class="btn" href="${i.button.href}" target="_blank">${i.button.text}</a>` : ""
      }</div></li>`;
      if(i.sub){ i.sub.forEach(s=>{
        if (typeof s.render === "function") {
          html += `<li style="margin-left:2em;margin-bottom:.75em;width:100%">${s.render()}</li>`;
        } else {
          html += `<li style="margin-left:2em;margin-bottom:.75em">${s.done?"✅":"⬜"} ${s.label}${s.details?`<div style='margin-left:1.5em;color:#555'>${s.details}</div>`:""}${s.button?`<a class="btn" href="${s.button.href}" target="_blank">${s.button.text}</a>`:""}</li>`;
        }
      }); }
    });
    html += `</ul></div>`;

    if (hasTag(TAGS.NSI_BOOKED)||hasTag(TAGS.DC_BOOKED)) {
      html += `<h2>Your trial</h2>
      <div class="checklist-block"><ul>`;
      trial.forEach(i=>{
        html += `<li style="display:flex;justify-content:space-between;align-items:center;margin:1rem 0"><div>${i.done?"✅":"⬜"} <strong>${i.label}</strong>${i.status?` — <em>${i.status}</em>`:""}${i.details?`<div style="margin-left:1.5em;color:#555">${i.details}</div>`:""}</div><div>${i.button?`<a class="btn" href="${i.button.href}" target="_blank">${i.button.text}</a>`:""}</div></li>`;
        if(i.sub){ i.sub.forEach(s=>{ html += `<li style="margin-left:2em;margin-bottom:.75em">${s.done?"✅":"⬜"} ${s.label}${s.details?`<div style='margin-left:1.5em;color:#555'>${s.details}</div>`:""}${s.button?`<a class="btn" href="${s.button.href}" target="_blank">${s.button.text}</a>`:""}</li>`; }); }
      });
      html += `</ul></div>`;
    }
    // === MAIN CHECKLIST HTML END ===

    container.innerHTML = html;
  }

  renderChecklist();
  setInterval(renderChecklist, 3000);
})();
</script>